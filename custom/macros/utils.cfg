[delayed_gcode INIT_PRINTER]
initial_duration: 2
gcode:
    RESET_TO_START_STATE

[gcode_macro RESET_MULTIPLIERS]
gcode:
    RESPOND MSG="Resetting multipliers to 100%."
    M220 S100
    M221 S100

[gcode_macro RESET_SAVED_VARS]
gcode:
      RESPOND MSG="Setting saved vars to pre-print state."
      SAVE_VARIABLE VARIABLE=is_printing_gcode VALUE=False
      SAVE_VARIABLE VARIABLE=current_material VALUE='"None"'

[gcode_macro RESET_TO_START_STATE]
description: resets saved variables back to start state
gcode:
    RESPOND MSG="Resetting printer to pre-print state."
    RESET_MULTIPLIERS
    RESET_SAVED_VARS

[gcode_macro MAYBE_LOAD_SKEW_CORRECTION]
gcode:
    {% set vars = printer["gcode_macro _PRINTER_VARS"] %}
    {% set profile = vars.skew_profile|default("default") %}
    RESPOND MSG="Attempting to load skew correction profile '{profile}'"
    {% if "skew_correction" in printer.configfile.settings %}
      SKEW_PROFILE LOAD={profile}
      RESPOND MSG="Skew correction profile '{profile}' loaded"
    {% endif %}

[gcode_macro DISABLE_XY]
gcode:
    RESPOND MSG="Disabling XY motors"
    {% if "stepper_x" in printer.configfile.settings %} SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0 {% endif %}
    {% if "stepper_y" in printer.configfile.settings %} SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0 {% endif %}


[gcode_macro DISABLE_ALL_MOTORS]
gcode:
    RESPOND MSG="Disabling all motors"
    M84  # All Motors off

[gcode_macro TURN_OFF_HEATERS]
rename_existing: TURN_OFF_HEATERS_BASE
gcode:
      RESPOND MSG="Turning off all heaters"
      TURN_OFF_HEATERS_BASE


[gcode_macro _FALLBACK_PURGE]
variable_length: 25
variable_speed: 10
gcode:
  {% set purge_length = params.LENGTH|default(length)|float %}
  {% set travel_speed = (params.SPEED|default(speed)|float * 60)|int %}
  {% set x0 = printer.toolhead.axis_minimum.x|float + 2 %}
  {% set y0 = printer.toolhead.axis_minimum.y|float + 2 %}
  G90
  G1 X{x0} Y{y0} F{travel_speed}
  G1 E{purge_length/5.0} F{(5*60)}
  G1 X{x0 + purge_length} F{travel_speed}
  G92 E0

[idle_timeout]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set is_printing_gcode = svv.is_printing_gcode %}
  {% if is_printing_gcode %}
    {action_respond_info("Idle Timeout Reached: Cancelling Print")}
    CANCEL_PRINT
  {% else %}
    {action_respond_info("Idle Timeout Reached: Steppers and Heaters powered down")}
    TURN_OFF_HEATERS ; Builtin kalico macro
    DISABLE_ALL_MOTORS
  {% endif %}