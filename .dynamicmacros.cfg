[gcode_macro TA_CHAMBER_HEAT]
description = Stage heat/airflow, then loop full mixing patterns until chamber reaches target
gcode = {% set vars =  printer["gcode_macro _PRINTER_VARS"] %}
	{% set chamber_target_temp = params.TARGET_CHAMBER_TEMP|default(vars.default_chamber_target)|float %}
	{% set bed_temp     = params.BED_TEMP|default(105)|float %}
	{% set hotend_temp  = params.HOTEND_TEMP|default(vars.default_chamber_assist_extruder_temp)|float %}
	{% set pattern_param    = params.PATTERN|default("auto")|lower %}
	{% set interval_ms      = (params.INTERVAL_MS|default(vars.chamber_status_interval|default(2))|float * 1000)|int %}
	{% set sensor_name = vars.chamber_sensor_name if vars.chamber_sensor_name is defined else "chamber" %}
	{% set sensor_key  = "temperature_sensor " ~ sensor_name %}
	DYNAMIC_MACRO MACRO=TA_CHAMBER_HEAT {rawparams}

[gcode_macro TA_CHAMBER_STOP]
gcode = 
	DYNAMIC_MACRO MACRO=TA_CHAMBER_STOP {rawparams}

[gcode_macro TA_CHAMBER_STATE]
variable_stop = 0
gcode = 
	DYNAMIC_MACRO MACRO=TA_CHAMBER_STATE {rawparams}

[gcode_macro TA_CHAMBER_CYCLE]
description = One full mixing pattern, wait, then re-call until chamber reaches target
gcode = {% set vars = printer["gcode_macro _PRINTER_VARS"] %}
	{% set sensor_key      = params.SENSOR %}
	{% set chamber_target_temp        = params.TARGET|float %}
	{% set pattern_name    = params.PATTERN|lower %}
	{% set wait_ms         = params.INTERVAL_MS|int %}
	{% set bed_temp    = params.BED_TARGET|float %}
	{% set hotend_temp = params.HOTEND_TARGET|float %}
	{% set chamber_state = printer["gcode_macro TA_CHAMBER_STATE"] if "gcode_macro TA_CHAMBER_STATE" in printer else None %}
	{% set at_target = (sensor_key in printer) and (printer[sensor_key].temperature|float >= chamber_target_temp) %}
	{% set x_min = printer.toolhead.axis_minimum.x|float %}
	{% set x_max = printer.toolhead.axis_maximum.x|float %}
	{% set y_min = printer.toolhead.axis_minimum.y|float %}
	{% set y_max = printer.toolhead.axis_maximum.y|float %}
	{% set bed_avg = ((x_max - x_min) + (y_max - y_min)) / 2.0 %}
	{% set move_speed_mmps = vars.chamber_move_speed_fast|float %}
	{% set bed_margin = 40 %}
	{% set move_speed_mmps = vars.chamber_move_speed_medium|float %}
	{% set bed_margin = 30 %}
	{% set move_speed_mmps = vars.chamber_move_speed_slow|float %}
	{% set bed_margin = 20 %}
	{% set move_speed = (move_speed_mmps * 60)|int %}
	{% set safe_x_min = x_min + bed_margin %}
	{% set safe_x_max = x_max - bed_margin %}
	{% set safe_y_min = y_min + bed_margin %}
	{% set safe_y_max = y_max - bed_margin %}
	{% set cx = (x_min + x_max)/2.0 %}
	{% set cy = (y_min + y_max)/2.0 %}
	{% set z_req = vars.chamber_printhead_height|float %}
	{% set z_lo  = printer.toolhead.axis_minimum.z|float + 2 %}
	{% set z_hi  = printer.toolhead.axis_maximum.z|float - 2 %}
	{% set mix_z = z_req %}
	{% if mix_z > z_hi %}{% set mix_z = z_hi %}{% endif %}
	{% if mix_z < z_lo %}{% set mix_z = z_lo %}{% endif %}
	{% set gx0=safe_x_min %}{% set gx1=(safe_x_min+safe_x_max)/2 %}{% set gx2=safe_x_max %}
	{% set gy0=safe_y_min %}{% set gy1=(safe_y_min+safe_y_max)/2 %}{% set gy2=safe_y_max %}
	{% set max_r = (safe_x_max - cx) if (safe_x_max - cx) < (safe_y_max - cy) else (safe_y_max - cy) %}
	{% set radius = s*max_r %}
	DYNAMIC_MACRO MACRO=TA_CHAMBER_CYCLE {rawparams}

